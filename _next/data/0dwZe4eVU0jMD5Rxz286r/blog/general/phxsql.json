{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var h=Object.create;var i=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var c=a=>i(a,\"__esModule\",{value:!0});var N=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=>{c(a);for(var t in s)i(a,t,{get:s[t],enumerable:!0})},g=(a,s,t)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let n of m(s))!u.call(a,n)&&n!==\"default\"&&i(a,n,{get:()=>s[n],enumerable:!(t=d(s,n))||t.enumerable});return a},y=a=>g(c(i(a!=null?h(p(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((T,l)=>{l.exports=_jsx_runtime});var x={};k(x,{default:()=>w,frontmatter:()=>f});var e=y(r()),f={title:\"A Look Back at WeChat's PhxSQL and the 'Fastest Majority'\",date:\"2025-07-18\",tags:[\"Architect\"],draft:!1,summary:`This post explores how WeChat's PhxSQL uses the \"Fastest Majority\" principle to offer a timeless lesson in designing fast and resilient distributed database systems.`,images:[]};function b(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(t,{})})):t();function t(){let n=Object.assign({p:\"p\",h2:\"h2\",a:\"a\",span:\"span\",h3:\"h3\",ol:\"ol\",li:\"li\",strong:\"strong\",ul:\"ul\",pre:\"pre\",code:\"code\"},a.components),{Image:o}=n;return o||v(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"It's 2016, and I'm working at WeChat (yes, that WeChat with over a billion users). Every day, servers are dying left and right \\u2013 not because our hardware is garbage, but because when you have THAT many servers, even a 0.001% failure rate means something breaks every few minutes. It's like having a million light bulbs in your house; statistically, one of them is going to burn out while you're eating breakfast.\"}),(0,e.jsx)(n.p,{children:`Fast forward to 2025, and I'm thinking about building a highly available secrets manager system. Suddenly, memories of PhxSQL come flooding back \\u2013 that brilliant piece of engineering that WeChat open-sourced nine years ago, which somehow never got the attention it deserved. Maybe it's because not many companies have WeChat's \"billion users with payment systems\" problems. Most folks are still figuring out how to handle their first million users without their database catching fire.`}),(0,e.jsx)(n.p,{children:\"Disclaimer: This article reflects my personal views and experiences. The content is not related to my previous or current employers.\"}),(0,e.jsxs)(n.h2,{id:\"the-cross-region-latency-curse--every-dbas-nightmare\",children:[(0,e.jsx)(n.a,{href:\"#the-cross-region-latency-curse--every-dbas-nightmare\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),`The \"Cross-Region Latency Curse\" \\u2013 Every DBA's Nightmare`]}),(0,e.jsx)(n.p,{children:`Let me paint you a picture of distributed database hell. You've got your fancy \"two regions, three centers\" setup \\u2013 maybe 2 nodes in Guangzhou, 1 node in Shanghai. You feel smart, you feel prepared for disasters. Then reality hits.`}),(0,e.jsx)(n.p,{children:`All consensus algorithms (Paxos, Raft, your uncle's homemade distributed protocol) work like a committee meeting where everyone needs to agree before anything gets done. In a cross-region setup, this means waiting for that one slow committee member in Shanghai to raise their hand and say \"I agree\" \\u2013 over a network connection that takes 30+ milliseconds round trip.`}),(0,e.jsx)(n.p,{children:`It's like trying to have a conversation where every sentence takes 30 seconds to travel. By the time Shanghai says \"yes,\" Guangzhou has already forgotten what they were talking about.`}),(0,e.jsxs)(n.h2,{id:\"phxsqls-brilliant-solution-the-fastest-majority-hack\",children:[(0,e.jsx)(n.a,{href:\"#phxsqls-brilliant-solution-the-fastest-majority-hack\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),`PhxSQL's Brilliant Solution: The \"Fastest Majority\" Hack`]}),(0,e.jsx)(n.p,{children:`Here's where PhxSQL gets clever. Instead of waiting for the slowest kid in class, it just waits for the fastest majority. Let me break down how this works in our \"Guangzhou 2 + Shanghai 1\" setup:`}),(0,e.jsxs)(n.h3,{id:\"the-magic-behind-the-scenes\",children:[(0,e.jsx)(n.a,{href:\"#the-magic-behind-the-scenes\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Magic Behind the Scenes\"]}),(0,e.jsx)(n.p,{children:\"When you have 3 nodes, you need 2 votes to make any decision (that's your majority). Now, here's the genius part:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"The Leader is Usually Local\"}),\": The master node will almost always be one of the Guangzhou nodes because they have better network connectivity to each other.\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:'The \"Committee Meeting\" Process'}),\": When Master Node A in Guangzhou wants to write something:\"]})]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"It sends the write request to both Guangzhou Node B and Shanghai Node C\"}),(0,e.jsx)(n.li,{children:\"Guangzhou Node B responds in ~2ms (same city, same coffee shop WiFi speed)\"}),(0,e.jsx)(n.li,{children:\"Shanghai Node C takes ~30ms to respond (cross-region, probably stuck in traffic)\"})]}),(0,e.jsx)(n.ol,{start:\"3\",children:(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:`The \"Don't Wait for the Slow Guy\" Philosophy`}),\": As soon as Master Node A gets confirmation from Guangzhou Node B, it has 2 votes (itself + Node B). That's a majority! It can immediately:\"]})}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Commit the transaction locally\"}),(0,e.jsx)(n.li,{children:'Tell the client \"success!\"'}),(0,e.jsx)(n.li,{children:\"Not care that Shanghai Node C is still processing the request\"})]}),(0,e.jsx)(n.p,{children:`It's like starting the movie as soon as 2 out of 3 friends arrive, instead of waiting for the one who's \"5 minutes away\" for the past hour.`}),(0,e.jsxs)(n.h2,{id:\"my-go--raft-implementation-phxsqls-soul-in-modern-clothes\",children:[(0,e.jsx)(n.a,{href:\"#my-go--raft-implementation-phxsqls-soul-in-modern-clothes\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"My Go + Raft Implementation: PhxSQL's Soul in Modern Clothes\"]}),(0,e.jsx)(n.p,{children:`While thinking about this secrets manager project, I decided to implement PhxSQL's core philosophy using Go, Raft, and SQLite. Here's the heart of the \"Fastest Majority\" implementation:`}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-go\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"n \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"replicateAndWaitForMajority\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"entry LogEntry\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"bool\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    majorityNeeded \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"len\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peers\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"var\"}),\" successCount \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        sync\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Mutex\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        count \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    successCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"count \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Count ourselves\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    doneChan \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"make\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"chan\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"bool\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Send to all peers concurrently\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"_\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" peer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"range\"}),\" peers \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"go\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peer \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"string\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"sendAppendRequest\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                successCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Lock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                successCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"count\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                isMajority \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" successCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"count \",(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),` majorityNeeded\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                successCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Unlock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`                \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" isMajority \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"select\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" doneChan \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<-\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"true\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// We got majority!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"default\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Wait for majority OR timeout\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"select\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<-\"}),\"doneChan\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"true\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Success! We got our majority\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<-\"}),\"time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"After\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Second\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"false\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Timeout, no majority\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"The beauty is in the \",(0,e.jsx)(n.code,{children:\"select\"}),\" statement. We're racing all the network requests, and as soon as we get enough votes for a majority, we declare victory and move on. No waiting for stragglers!\"]}),(0,e.jsxs)(n.h2,{id:\"testing-the-magic\",children:[(0,e.jsx)(n.a,{href:\"#testing-the-magic\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Testing the Magic\"]}),(0,e.jsx)(n.p,{children:\"Let me show you this in action. I started 3 nodes and ran some tests:\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-bash\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Create a table\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -X POST http://localhost:8001/sql -d \",(0,e.jsx)(n.span,{className:\"token string\",children:`'{\"sql\":\"CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)\"}'`}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"success\"'}),\":true,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"result\"'}),\":\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows\"'}),\":null,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows_affected\"'}),\":0,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"last_insert_id\"'}),\":0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Insert some data\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -X POST http://localhost:8001/sql -d \",(0,e.jsx)(n.span,{className:\"token string\",children:`'{\"sql\":\"INSERT INTO users (name) VALUES (?)\", \"args\":[\"Alice\"]}'`}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"success\"'}),\":true,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"result\"'}),\":\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows\"'}),\":null,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows_affected\"'}),\":1,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"last_insert_id\"'}),\":1\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -X POST http://localhost:8001/sql -d \",(0,e.jsx)(n.span,{className:\"token string\",children:`'{\"sql\":\"INSERT INTO users (name) VALUES (?)\", \"args\":[\"Bob\"]}'`}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"success\"'}),\":true,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"result\"'}),\":\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows\"'}),\":null,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows_affected\"'}),\":1,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"last_insert_id\"'}),\":2\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Query from different nodes - data is replicated!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -X POST http://localhost:8002/sql -d \",(0,e.jsx)(n.span,{className:\"token string\",children:`'{\"sql\":\"SELECT * FROM users\"}'`}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"success\"'}),\":true,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"result\"'}),\":\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows\"'}),\":\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"id\"'}),\":1,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"name\"'}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Alice\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\",\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"id\"'}),\":2,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"name\"'}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Bob\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\",\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"rows_affected\"'}),\":0,\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"last_insert_id\"'}),\":0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Node 1 logs show the election process:\"}),(0,e.jsx)(o,{width:600,src:\"/static/images/general/raftdb1.png\"}),(0,e.jsxs)(n.h2,{id:\"the-trade-off-speed-vs-absolute-durability\",children:[(0,e.jsx)(n.a,{href:\"#the-trade-off-speed-vs-absolute-durability\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Trade-off: Speed vs. Absolute Durability\"]}),(0,e.jsx)(n.p,{children:`Now, let's address the elephant in the room. What if Guangzhou gets hit by a meteor right after the client receives \"success\" but before Shanghai gets the data? Well, that data is gone forever.`}),(0,e.jsxs)(n.p,{children:[\"This isn't a bug \\u2013 it's a feature! PhxSQL makes a deliberate choice: \",(0,e.jsx)(n.strong,{children:\"optimize for the 99.999% case where regions don't get destroyed, rather than the 0.001% disaster scenario.\"})]}),(0,e.jsx)(n.p,{children:\"For most applications, losing a few writes during a complete regional disaster is acceptable. The alternative \\u2013 making every write operation 30ms slower to guard against meteor strikes \\u2013 would make your users suffer every single day for a scenario that hopefully never happens.\"}),(0,e.jsxs)(n.h2,{id:\"why-phxsql-never-became-the-next-big-thing\",children:[(0,e.jsx)(n.a,{href:\"#why-phxsql-never-became-the-next-big-thing\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Why PhxSQL Never Became the Next Big Thing\"]}),(0,e.jsx)(n.p,{children:\"Nine years have passed since WeChat open-sourced PhxSQL, and it never really took off. Here's my theory:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:'The \"WeChat Problem\" is Rare'}),\": Not many companies have billion-user social networks with payment systems. Most companies are still figuring out how to handle their first million users.\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Cloud-Native Happened\"}),\": In 2025, most companies just use managed database services with built-in HA. Why build your own distributed database when AWS RDS or Google Cloud SQL does it for you?\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Ecosystem Matters\"}),\": PhxSQL never built the ecosystem. No fancy dashboard, no Docker images, no Kubernetes operators. If you can't deploy it with one YAML file, modern DevOps teams won't touch it.\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"On-Premise is Dead\"}),\": Most companies moved to the cloud. Those who didn't probably went with TiDB or other modern distributed databases.\"]})]}),(0,e.jsxs)(n.h2,{id:\"the-lasting-legacy-the-philosophy-still-matters\",children:[(0,e.jsx)(n.a,{href:\"#the-lasting-legacy-the-philosophy-still-matters\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Lasting Legacy: The Philosophy Still Matters\"]}),(0,e.jsx)(n.p,{children:`Even though PhxSQL itself might be a museum piece, its \"Fastest Majority\" philosophy is still relevant in 2025. Whether you're building microservices, distributed caches, or that secrets manager I mentioned, remember:`}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:(0,e.jsx)(n.strong,{children:\"Optimize for the common case, not the disaster scenario\"})}),(0,e.jsx)(n.li,{children:(0,e.jsx)(n.strong,{children:\"Don't let the slowest node dictate your performance\"})}),(0,e.jsx)(n.li,{children:(0,e.jsx)(n.strong,{children:'Sometimes \"fast enough\" is better than \"perfectly consistent\"'})})]}),(0,e.jsxs)(n.h2,{id:\"my-wechat-days-learning-from-giants\",children:[(0,e.jsx)(n.a,{href:\"#my-wechat-days-learning-from-giants\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"My WeChat Days: Learning from Giants\"]}),(0,e.jsx)(n.p,{children:`Back when I was part of the WeChat team, dealing with scale was a daily reality. When you have over a billion daily active users across social messaging, payments, and mini-programs, hardware failures aren't \"if\" \\u2013 they're \"when\" and \"how many today?\" WeChat's approach to PhxSQL made perfect sense in that context. The team had:`}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Deep MySQL expertise (it's the most widely used database in China)\"}),(0,e.jsx)(n.li,{children:\"Extensive Paxos algorithm experience (they also open-sourced Paxos-based NoSQL and message queue systems)\"}),(0,e.jsx)(n.li,{children:\"A real need for automated failure handling and node replacement\"})]}),(0,e.jsx)(n.p,{children:\"Building a Paxos layer on top of MySQL wasn't just clever \\u2013 it was necessary survival at that scale.\"}),(0,e.jsxs)(n.h2,{id:\"sometimes-the-old-ways-are-still-good-ways\",children:[(0,e.jsx)(n.a,{href:\"#sometimes-the-old-ways-are-still-good-ways\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Sometimes the Old Ways Are Still Good Ways\"]}),(0,e.jsx)(n.p,{children:\"Would I recommend PhxSQL for a new project in 2025? Probably not. Would I recommend understanding its philosophy? Absolutely.\"}),(0,e.jsx)(n.p,{children:`In our rush toward cloud-native, serverless, and AI-everything, we sometimes forget that some of the best engineering solutions come from understanding fundamental trade-offs. PhxSQL's \"Fastest Majority\" approach is a masterclass in making the right compromises.`}),(0,e.jsx)(n.p,{children:\"So the next time you're designing a distributed system, remember: you don't always need to wait for the slowest member of the committee. Sometimes, the fastest majority is all you need.\"}),(0,e.jsxs)(n.p,{children:[\"P.S. - The full Go implementation is \",(0,e.jsx)(n.a,{href:\"https://github.com/liweijian/RaxSQL\",children:\"available\"}),\" if you want to play with it. It's about 900 lines of code that capture the essence of a system that handled billions of users. Not bad for a weekend project!\"]})]})}}var w=b;function v(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return x;})();\n;return Component;","toc":[{"value":"The \"Cross-Region Latency Curse\" – Every DBA's Nightmare","url":"#the-cross-region-latency-curse--every-dbas-nightmare","depth":2},{"value":"PhxSQL's Brilliant Solution: The \"Fastest Majority\" Hack","url":"#phxsqls-brilliant-solution-the-fastest-majority-hack","depth":2},{"value":"The Magic Behind the Scenes","url":"#the-magic-behind-the-scenes","depth":3},{"value":"My Go + Raft Implementation: PhxSQL's Soul in Modern Clothes","url":"#my-go--raft-implementation-phxsqls-soul-in-modern-clothes","depth":2},{"value":"Testing the Magic","url":"#testing-the-magic","depth":2},{"value":"The Trade-off: Speed vs. Absolute Durability","url":"#the-trade-off-speed-vs-absolute-durability","depth":2},{"value":"Why PhxSQL Never Became the Next Big Thing","url":"#why-phxsql-never-became-the-next-big-thing","depth":2},{"value":"The Lasting Legacy: The Philosophy Still Matters","url":"#the-lasting-legacy-the-philosophy-still-matters","depth":2},{"value":"My WeChat Days: Learning from Giants","url":"#my-wechat-days-learning-from-giants","depth":2},{"value":"Sometimes the Old Ways Are Still Good Ways","url":"#sometimes-the-old-ways-are-still-good-ways","depth":2}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.085,"time":485100,"words":1617},"slug":"general/phxsql","fileName":"general/phxsql.md","title":"A Look Back at WeChat's PhxSQL and the 'Fastest Majority'","date":"2025-07-18T00:00:00.000Z","tags":["Architect"],"draft":false,"summary":"This post explores how WeChat's PhxSQL uses the \"Fastest Majority\" principle to offer a timeless lesson in designing fast and resilient distributed database systems.","images":[]}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.72,"time":43200,"words":144},"slug":["default"],"fileName":"default.md","name":"Ted","avatar":"/static/images/avatar.jpg","occupation":"CISSP, CKS, AWS Certified Security – Specialty, Microsoft Cybersecurity Architect Expert","email":"nerd@supasaf.com","twitter":"https://twitter.com/supasaf","date":null}],"prev":{"title":"An InfoSec Architect's First Taste of Temporal","date":"2025-07-08T00:00:00.000Z","tags":["Secrets Management"],"draft":false,"summary":"This is a therapy session for anyone traumatized by fragile scripts. I traded my `cron/try/catch` nightmares for a robot project manager named Temporal.","images":[],"slug":"general/temporal"},"next":null},"__N_SSG":true}