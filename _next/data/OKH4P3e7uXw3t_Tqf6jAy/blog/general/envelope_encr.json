{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var l=Object.create;var r=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var y=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var c=t=>r(t,\"__esModule\",{value:!0});var u=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports),g=(t,a)=>{c(t);for(var i in a)r(t,i,{get:a[i],enumerable:!0})},f=(t,a,i)=>{if(a&&typeof a==\"object\"||typeof a==\"function\")for(let n of h(a))!m.call(t,n)&&n!==\"default\"&&r(t,n,{get:()=>a[n],enumerable:!(i=p(a,n))||i.enumerable});return t},k=t=>f(c(r(t!=null?l(y(t)):{},\"default\",t&&t.__esModule&&\"default\"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var d=u((A,o)=>{o.exports=_jsx_runtime});var x={};g(x,{default:()=>S,frontmatter:()=>b});var e=k(d()),b={title:\"Envelope Encryption: Boosting Cloud Security with KMS\",date:\"2023-07-02\",tags:[\"Cloud\",\"AWS\",\"Cryptography\"],draft:!1,summary:\"Explore envelope encryption and its importance for cloud security, using AWS Key Management Service (KMS) and OpenSSL to protect sensitive data.\",images:[]};function w(t={}){let{wrapper:a}=t.components||{};return a?(0,e.jsx)(a,Object.assign({},t,{children:(0,e.jsx)(i,{})})):i();function i(){let n=Object.assign({p:\"p\",pre:\"pre\",code:\"code\",span:\"span\",ul:\"ul\",li:\"li\",a:\"a\"},t.components),{Image:s}=n;return s||v(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"Before the advent of the cloud computing era, data encryption was a very important topic. Looking back, when I read Chapter 7. Cryptography Basics of 'Practical Unix & Internet Security' in prehistory, I learned a lot about how cryptography is important for the security architecture of back-end services. Even in today's cloud computing era, this technology can still play a very important role.\"}),(0,e.jsx)(s,{width:600,src:\"/static/images/general/practical_unix_internet_sec.jpeg\"}),(0,e.jsx)(n.p,{children:\"In today's ever-evolving digital landscape, data security is more important than ever. Cloud-based storage and services have become increasingly popular, but with that comes the challenge of ensuring data remains secure and confidential. One essential technique in the realm of cloud security is envelope encryption, which provides an additional layer of protection for large data files. In this blog post, we'll dive into the concept of envelope encryption, its significance for cloud security, and how to implement it using AWS Key Management Service (KMS) and OpenSSL.\"}),(0,e.jsx)(n.p,{children:\"Envelope encryption is a technique that combines symmetric and asymmetric encryption methods to protect large volumes of data efficiently. The process involves encrypting a file using a symmetric data key, which is then encrypted using a master key, typically provided by a key management service like AWS KMS. The encrypted data key and the encrypted file are stored together, while the master key remains securely stored in the key management service.\"}),(0,e.jsx)(n.p,{children:\"The main advantage of envelope encryption is that it minimizes the risk of exposing the plaintext data key, as the master key never directly interacts with the data. This approach is particularly useful in cloud environments, where data is often distributed across multiple services, and security becomes a challenge due to the vast number of potential attack vectors.\"}),(0,e.jsx)(n.p,{children:\"Here's a step-by-step guide to implementing envelope encryption using AWS KMS and OpenSSL:\"}),(0,e.jsx)(n.p,{children:\"Generate a data key using AWS KMS:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`aws kms generate-data-key --key-id 085865dc-8e72-42a9-94d6-f60cb43f637b --key-spec AES_256\n`})})}),(0,e.jsxs)(n.p,{children:[\"This command creates a new data key, encrypted with the specified KMS key. Make sure the \",(0,e.jsx)(n.code,{children:\"key-id\"}),\" is exists in the AWS console.\"]}),(0,e.jsx)(s,{width:400,src:\"/static/images/general/general_kms_arn.png\"}),(0,e.jsx)(n.p,{children:\"The output would be the follow format:\"}),(0,e.jsx)(n.pre,{className:\"language-json\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-json\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"CiphertextBlob\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"AQIDAHgp3upyUvXfYTtaE+GSFfzK5pkL/Jc37eipuMi8fqwifwGrgrzt+nBcuzgUefb0Tr7gAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMY626nlBe9k1ZWwoMAgEQgDuvQdZS/mBKVl0cF35ht7iq4WTz1ZlOW/kBARrndF7RHSxU3Kvc7+0PSpcJ28wcmeicvfxdzEs8R681kQ==\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"Plaintext\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"4iP4KiWfyMT43I6VnlmbTXB59ZaWp5U6ZOwCeOKFTOE=\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"KeyId\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"arn:aws:kms:us-west-2:392653644284:key/085865dc-8e72-42a9-94d6-f60cb43f637b\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"CiphertextBlob\"}),\" and \",(0,e.jsx)(n.code,{children:\"Plaintext\"}),\" are two properties returned when generating a data key using the AWS KMS command.\"]}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"CiphertextBlob\"}),\" is the encrypted data key produced by the AWS KMS service using the specified master key. It is presented as a Base64-encoded string. The ciphertext blob can be used to securely store or transmit the data key during data transfer. Only users with the corresponding master key can decrypt the ciphertext blob to obtain the original data key.\"]}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"Plaintext\"}),\" is the plaintext data key, which is the raw form of the generated random key encoded in Base64. The plaintext data key is used for encryption and decryption operations when using cryptographic algorithms. Only users with the ciphertext blob can decrypt it and use the plaintext data key for encrypting or decrypting data.\"]}),(0,e.jsx)(n.p,{children:\"These two properties have the following use cases in AWS KMS:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"CiphertextBlob\"}),\" is used for secure storage or transmission of the data key to ensure its confidentiality during transit.\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"Plaintext\"}),\" is used for actual encryption and decryption operations as it serves as the raw key for the cryptographic algorithm.\"]})]}),(0,e.jsx)(n.p,{children:\"It is important to note that safeguarding and managing the security of these data keys is crucial to ensure the confidentiality and integrity of the data.\"}),(0,e.jsx)(n.p,{children:\"Save the encrypted data key to a binary file:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`echo <CiphertextBlob> | base64 -d > enc_data_key.bin\n`})})}),(0,e.jsxs)(n.p,{children:[\"Replace \",(0,e.jsx)(n.code,{children:\"<CiphertextBlob>\"}),\" with the Base64-encoded encrypted data key returned by the \",(0,e.jsx)(n.code,{children:\"aws kms generate-data-key\"}),\" command.\"]}),(0,e.jsx)(n.p,{children:\"Encrypt the file using OpenSSL and the plaintext data key:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`openssl enc -aes-256-cbc -pbkdf2 -in secret_file.txt -out encrypted_secret_file.txt -pass pass:<Plaintext>\n`})})}),(0,e.jsxs)(n.p,{children:[\"Replace \",(0,e.jsx)(n.code,{children:\"<Plaintext>\"}),\" with the plaintext data key generated in \",(0,e.jsx)(n.code,{children:\"aws kms generate-data-key\"}),\", and adjust the input and output file paths as needed. You may need to \",(0,e.jsx)(n.code,{children:\"brew install openssl\"}),\" if you are using macOS. (\",(0,e.jsx)(n.a,{href:\"https://stackoverflow.com/a/63341786/1319619\",children:\"refer\"}),\")\"]}),(0,e.jsx)(n.p,{children:\"When you need to decrypt the file, first use AWS KMS to decrypt the encrypted data key:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`aws kms decrypt --ciphertext-blob fileb://enc_data_key.bin\n`})})}),(0,e.jsx)(n.p,{children:\"The output would like:\"}),(0,e.jsx)(n.pre,{className:\"language-json\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-json\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"KeyId\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"arn:aws:kms:us-west-2:392653644284:key/085865dc-8e72-42a9-94d6-f60cb43f637b\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"Plaintext\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"4iP4KiWfyMT43I6VnlmbTXB59ZaWp5U6ZOwCeOKFTOE=\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"EncryptionAlgorithm\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"SYMMETRIC_DEFAULT\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Decrypt the file using OpenSSL and the decrypted plaintext data key:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`openssl enc -d -aes-256-cbc -pbkdf2 -in encrypted_secret_file.txt -out decrypted_secret_file.txt -pass pass:<Plaintext>\n`})})}),(0,e.jsxs)(n.p,{children:[\"Replace \",(0,e.jsx)(n.code,{children:\"<Plaintext>\"}),\" with the decrypted plaintext data key obtained from \",(0,e.jsx)(n.code,{children:\"aws kms decrypt\"}),\", and adjust the input and output file paths as needed.\"]}),(0,e.jsx)(n.p,{children:\"By leveraging envelope encryption and tools like AWS KMS and OpenSSL, you can significantly bolster the security of your cloud-based data. Envelope encryption provides an added layer of protection that helps to mitigate the risk of data breaches and ensures that sensitive information remains confidential. Embracing envelope encryption and other security best practices is crucial for maintaining the integrity of your data in an increasingly interconnected world. Stay tuned for more cloud security tips and guides in upcoming blog posts.\"})]})}}var S=w;function v(t,a){throw new Error(\"Expected \"+(a?\"component\":\"object\")+\" `\"+t+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return x;})();\n;return Component;","toc":[],"frontMatter":{"readingTime":{"text":"5 min read","minutes":4.385,"time":263100,"words":877},"slug":"general/envelope_encr","fileName":"general/envelope_encr.md","title":"Envelope Encryption: Boosting Cloud Security with KMS","date":"2023-07-02T00:00:00.000Z","tags":["Cloud","AWS","Cryptography"],"draft":false,"summary":"Explore envelope encryption and its importance for cloud security, using AWS Key Management Service (KMS) and OpenSSL to protect sensitive data.","images":[]}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.675,"time":40500,"words":135},"slug":["default"],"fileName":"default.md","name":"L.W.J","avatar":"/static/images/avatar.png","occupation":"CISSP, AWS Certified Security â€“ Specialty, Microsoft Cybersecurity Architect Expert","email":"nerd@supasaf.com","twitter":"https://twitter.com/supasaf","date":null}],"prev":{"title":"Encrypting DynamoDB with AWS KMS: A Secure and Easy Guide","date":"2023-06-30T00:00:00.000Z","tags":["Terraform","Cloud","AWS"],"draft":false,"summary":"Discover how to use Terraform and AWS Key Management Service (KMS) to encrypt DynamoDB tables and enhance cybersecurity.","slug":"terraform/terraform_sec_5_kms_dynamodb"},"next":{"title":"AWS Security Specialty: What I Learned Preparing for the Exam","date":"2023-09-24T00:00:00.000Z","tags":["Cloud","AWS"],"draft":false,"summary":"Sharing my exam prep insights and key technical focus areas like IAM, KMS, and VPC to help others prepare for the AWS Security Specialty exam.","images":[],"slug":"general/aws_security_cert"}},"__N_SSG":true}