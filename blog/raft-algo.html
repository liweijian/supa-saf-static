<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Consensus Algorithms Through the Eyes of an Infosec Architect</title><meta name="robots" content="follow, index"/><meta name="description" content="a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot"/><meta property="og:url" content="https://www.supasaf.com/blog/raft-algo"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Cybersecurity, Cloud and Compiler"/><meta property="og:description" content="a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot"/><meta property="og:title" content="Consensus Algorithms Through the Eyes of an Infosec Architect"/><meta property="og:image" content="https://www.supasaf.com/static/images/twitter-card.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site"/><meta name="twitter:title" content="Consensus Algorithms Through the Eyes of an Infosec Architect"/><meta name="twitter:description" content="a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot"/><meta name="twitter:image" content="https://www.supasaf.com/static/images/twitter-card.png"/><link rel="canonical" href="https://www.supasaf.com/blog/raft-algo"/><meta property="article:published_time" content="2025-07-04T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.supasaf.com/blog/raft-algo"
  },
  "headline": "Consensus Algorithms Through the Eyes of an Infosec Architect",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://www.supasaf.com/static/images/twitter-card.png"
    }
  ],
  "datePublished": "2025-07-04T00:00:00.000Z",
  "dateModified": "2025-07-04T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Supa Saf"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Supa Safe",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.supasaf.com/static/images/logo2.png"
    }
  },
  "description": "a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot"
}</script><meta name="next-head-count" content="20"/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preload" href="/_next/static/css/52032488e305abd8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/52032488e305abd8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-7bf052786ac70438.js" defer=""></script><script src="/_next/static/chunks/main-80446c6fe86f961e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c8c0eb7eb758c19d.js" defer=""></script><script src="/_next/static/chunks/410-35c4fb535edd9439.js" defer=""></script><script src="/_next/static/chunks/1-53b2bdc23927c90b.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-0728882d0f489132.js" defer=""></script><script src="/_next/static/iZpAoEZnD18JWfagLiBRw/_buildManifest.js" defer=""></script><script src="/_next/static/iZpAoEZnD18JWfagLiBRw/_ssgManifest.js" defer=""></script><script src="/_next/static/iZpAoEZnD18JWfagLiBRw/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="Supa Safe" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g stroke-width="1.5" fill="none"><path stroke="#93a3a9" vector-effect="non-scaling-stroke" d="M255.59 32.64q-1.42-.7-3.54-1.73a1.5 1.49-45.2 0 0-1.32.01q-50.57 24.94-105.46 35.16Q99.16 74.67 52.7 75a.96.95-89.7 0 0-.95.95q-.16 35.05.24 69.05.56 47.23 9.78 93.54 22.44 112.62 103.44 192.11 7.03 6.89 14.68 13.57 32.68 28.51 70.66 50.1a1.23 1.23-45.1 0 0 1.24 0q40.62-23.16 75.25-54.53Q412.88 362.01 438 248.5q10.21-46.13 12.25-95.75.57-13.88.19-77.19a.51.5-89.4 0 0-.49-.51q-52.56-.84-96.7-10.05-28.79-6.01-56.65-15.41-21.08-7.11-41.01-16.95"></path><path stroke="#3b777e" vector-effect="non-scaling-stroke" d="M255.83 59.14q-2.08-.89-3.82-1.68a2.11 2.1 45.2 0 0-1.72-.01q-39.78 17.64-81.04 27.05Q122.6 95.15 74.8 97.54a.53.51 88.9 0 0-.49.53q-.09 23.34-.07 46.68.01 11.6.53 19.99 2.46 39.82 11.48 80.26 11.03 49.46 34.97 92.77 21.15 38.27 51.8 69.46 34.34 34.95 77.32 60.62a1.3 1.3 90 0 0 1.32 0q43.02-25.62 77.21-60.73 64.32-66.08 85.64-156.07 9.17-38.71 12.3-78.32.7-8.83 1-19.97.75-26.89.43-54.51a.73.72-89.2 0 0-.69-.72q-55.89-2.9-109.45-16.98-31.93-8.4-62.27-21.41"></path><path stroke="#a7d3d4" vector-effect="non-scaling-stroke" d="M202.69 315.81q19.99 18.66 48.13 35.43a.83.83 90 0 0 .86 0q21.29-12.65 40.29-28.42 9.61-7.98 14.13-14.06 11.65-15.69 11.65-35.76v-90.98a.52.52 90 0 0-.52-.52l-132.42.06a.5.49 0 0 0-.5.49q.32 45.48.38 90.95.03 26.05 18 42.81"></path><path stroke="#93a3aa" vector-effect="non-scaling-stroke" d="M195.06 187.52q-1.81-.09-4.01.03a.59.58 88.5 0 0-.55.59v71.12q0 16.12.49 19.97 2.71 21.36 19.85 35.93 18.84 16.01 39.98 28.83a.83.83 90 0 0 .86 0q19.76-11.9 38.88-27.93 20.76-17.39 20.83-44.56.11-41.38.11-83.55a.45.45 45 0 0-.45-.45q-55.89-.11-111.98.18-.5 0-4.01-.16"></path><path stroke="#93a3aa" vector-effect="non-scaling-stroke" d="m250.65 258.4-41.2-40.58q-.68-.67-.69.29l-.26 27.64a1.18 1.16-67.2 0 0 .34.85l41.72 41.83a.63.62-44.7 0 0 .89 0l41.45-41.58a1.28 1.17 69.8 0 0 .35-.85l.19-27.82q.01-1.24-.87-.38l-41.21 40.6a.51.5-44.6 0 1-.71 0"></path></g><path fill="#fffefe" d="M0 0h512v512H0V0Zm255.59 32.64q-1.42-.7-3.54-1.73a1.5 1.49-45.2 0 0-1.32.01q-50.57 24.94-105.46 35.16Q99.16 74.67 52.7 75a.96.95-89.7 0 0-.95.95q-.16 35.05.24 69.05.56 47.23 9.78 93.54 22.44 112.62 103.44 192.11 7.03 6.89 14.68 13.57 32.68 28.51 70.66 50.1a1.23 1.23-45.1 0 0 1.24 0q40.62-23.16 75.25-54.53Q412.88 362.01 438 248.5q10.21-46.13 12.25-95.75.57-13.88.19-77.19a.51.5-89.4 0 0-.49-.51q-52.56-.84-96.7-10.05-28.79-6.01-56.65-15.41-21.08-7.11-41.01-16.95Z"></path><path fill="#274754" d="M255.59 32.64q19.93 9.84 41.01 16.95 27.86 9.4 56.65 15.41 44.14 9.21 96.7 10.05a.51.5-89.4 0 1 .49.51q.38 63.31-.19 77.19-2.04 49.62-12.25 95.75-25.12 113.51-110.96 191.29-34.63 31.37-75.25 54.53a1.23 1.23-44.4 0 1-1.24 0q-37.98-21.59-70.66-50.1-7.65-6.68-14.68-13.57-81-79.49-103.44-192.11-9.22-46.31-9.78-93.54-.4-34-.24-69.05a.96.95-89.7 0 1 .95-.95q46.46-.33 92.57-8.92 54.89-10.22 105.46-35.16a1.5 1.49-45.2 0 1 1.32-.01q2.12 1.03 3.54 1.73Zm.24 26.5q-2.08-.89-3.82-1.68a2.11 2.1 45.2 0 0-1.72-.01q-39.78 17.64-81.04 27.05Q122.6 95.15 74.8 97.54a.53.51 88.9 0 0-.49.53q-.09 23.34-.07 46.68.01 11.6.53 19.99 2.46 39.82 11.48 80.26 11.03 49.46 34.97 92.77 21.15 38.27 51.8 69.46 34.34 34.95 77.32 60.62a1.3 1.3 90 0 0 1.32 0q43.02-25.62 77.21-60.73 64.32-66.08 85.64-156.07 9.17-38.71 12.3-78.32.7-8.83 1-19.97.75-26.89.43-54.51a.73.72-89.2 0 0-.69-.72q-55.89-2.9-109.45-16.98-31.93-8.4-62.27-21.41Z"></path><path fill="#4ea7a8" d="M255.83 59.14q30.34 13.01 62.27 21.41 53.56 14.08 109.45 16.98a.73.72-89.2 0 1 .69.72q.32 27.62-.43 54.51-.3 11.14-1 19.97-3.13 39.61-12.3 78.32-21.32 89.99-85.64 156.07-34.19 35.11-77.21 60.73a1.3 1.3-90 0 1-1.32 0q-42.98-25.67-77.32-60.62-30.65-31.19-51.8-69.46Q97.28 294.46 86.25 245q-9.02-40.44-11.48-80.26-.52-8.39-.53-19.99-.02-23.34.07-46.68a.53.51 88.9 0 1 .49-.53q47.8-2.39 94.45-13.04 41.26-9.41 81.04-27.05a2.11 2.1 45.2 0 1 1.72.01q1.74.79 3.82 1.68Zm-53.14 256.67q19.99 18.66 48.13 35.43a.83.83 90 0 0 .86 0q21.29-12.65 40.29-28.42 9.61-7.98 14.13-14.06 11.65-15.69 11.65-35.76v-90.98a.52.52 90 0 0-.52-.52l-132.42.06a.5.49 0 0 0-.5.49q.32 45.48.38 90.95.03 26.05 18 42.81Z"></path><path fill="#fff" d="M202.69 315.81q-17.97-16.76-18-42.81-.06-45.47-.38-90.95a.5.49 0 0 1 .5-.49l132.42-.06a.52.52-90 0 1 .52.52V273q0 20.07-11.65 35.76-4.52 6.08-14.13 14.06-19 15.77-40.29 28.42a.83.83-90 0 1-.86 0q-28.14-16.77-48.13-35.43Zm-7.63-128.29q-1.81-.09-4.01.03a.59.58 88.5 0 0-.55.59v71.12q0 16.12.49 19.97 2.71 21.36 19.85 35.93 18.84 16.01 39.98 28.83a.83.83 90 0 0 .86 0q19.76-11.9 38.88-27.93 20.76-17.39 20.83-44.56.11-41.38.11-83.55a.45.45 45 0 0-.45-.45q-55.89-.11-111.98.18-.5 0-4.01-.16Z"></path><path fill="#274654" d="M199.07 187.68q56.09-.29 111.98-.18a.45.45 45 0 1 .45.45q0 42.17-.11 83.55-.07 27.17-20.83 44.56-19.12 16.03-38.88 27.93a.83.83-90 0 1-.86 0q-21.14-12.82-39.98-28.83-17.14-14.57-19.85-35.93-.49-3.85-.49-19.97v-71.12a.59.58 88.5 0 1 .55-.59q2.2-.12 4.01-.03 3.51.16 4.01.16Zm51.58 70.72-41.2-40.58q-.68-.67-.69.29l-.26 27.64a1.18 1.16-67.2 0 0 .34.85l41.72 41.83a.63.62-44.7 0 0 .89 0l41.45-41.58a1.28 1.17 69.8 0 0 .35-.85l.19-27.82q.01-1.24-.87-.38l-41.21 40.6a.51.5-44.6 0 1-.71 0Z"></path><path fill="#fff" d="m251.36 258.4 41.21-40.6q.88-.86.87.38l-.19 27.82a1.28 1.17 69.8 0 1-.35.85l-41.45 41.58a.63.62-44.7 0 1-.89 0l-41.72-41.83a1.18 1.16-67.2 0 1-.34-.85l.26-27.64q.01-.96.69-.29l41.2 40.58a.51.5-44.6 0 0 .71 0Z"></path></svg></div><div class="hidden h-6 text-2xl font-semibold sm:block">Supa Safe</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-0 left-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><div class="flex justify-end"><button type="button" class="mr-5 mt-11 h-8 w-8 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Comment" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2025-07-04T00:00:00.000Z">Friday, July 4, 2025</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Consensus Algorithms Through the Eyes of an Infosec Architect</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="/static/images/avatar.jpg" width="38px" height="38px" alt="avatar" class="h-10 w-10 rounded-full"/><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Supa Saf</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/supasaf" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@supasaf</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><p>We’ve recently been evaluating some vendors for secrets management solutions. Due to some unfortunate legal or market reasons, well-known products like Akeyless can’t be sold in our local market. That pushed us to look into alternative solutions.</p><p>Now, secrets management demands <strong>extremely high availability</strong> (HA). I mean, nobody wants to wake up at 3 a.m. because the system storing your passwords decided to take a nap. So I spent some time analyzing how different vendors implement HA.</p><p>Some vendors use a <strong>primary-standby model</strong> based on traditional databases like PostgreSQL. Others go fancier and adopt <strong>consensus algorithms</strong> like Raft.</p><p>Yesterday, a teammate asked:</p><blockquote><p>“What exactly is a consensus algorithm?”</p></blockquote><p>That question hit me right in the brainstem.</p><p>I once worked for a company with a product that had over a billion DAUs. Under the hood, it used a Paxos-based system called <a target="_blank" rel="noopener noreferrer" href="https://github.com/Tencent/paxosstore">paxosstore</a>. The core logic? Less than 2,000 lines of C++. Nowadays, I have to admit — I can barely read that C++ anymore. But I thought — why not write a tiny version of Raft myself in Go? Just for fun and to sharpen my understanding of the secret manager tech we’re reviewing.</p><p><strong>Disclaimer: My little Raft only does leader election, failure recovery, and node restarts. It’s not ready for production or serious use. If you want a deep dive into a more solid Go implementation, check out <a target="_blank" rel="noopener noreferrer" href="https://eli.thegreenplace.net/2020/implementing-raft-part-1-elections/">this excellent series</a>.</strong></p><h2 id="tldr"><a href="#tldr" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>TL;DR</h2><ul><li>I wrote a Raft mini-clone in Go</li><li>It fits in a single file</li><li>It does elections and heartbeats</li><li>It doesn’t do log replication (yet)</li><li>But hey — it was fun!</li></ul><h2 id="what-does-this-raft-do"><a href="#what-does-this-raft-do" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What Does This Raft Do?</h2><p>Just the basics:</p><ul><li>Leader election</li><li>Heartbeats</li><li>Failover (when leader dies, a new one is elected)</li><li>REST API for testing</li></ul><p>Each node is just an HTTP server. They ping each other, vote for leaders, and complain when they don’t get love from others (i.e. no heartbeats).</p><h2 id="how-does-it-work"><a href="#how-does-it-work" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>How Does It Work?</h2><p>You start each node in a separate terminal:</p><div class="relative"><pre><code class="code-highlight"><span class="code-line"># Terminal 1
</span><span class="code-line">go run main.go 0
</span><span class="code-line">
</span><span class="code-line"># Terminal 2
</span><span class="code-line">go run main.go 1
</span><span class="code-line">
</span><span class="code-line"># Terminal 3
</span><span class="code-line">go run main.go 2
</span></code></pre></div><p>Meanwhile, I had a little monitoring shell script running to watch the cluster:</p><div class="relative"><pre><code class="code-highlight"><span class="code-line">$ ./test.sh monitor
</span><span class="code-line">=== Raft Cluster Status Monitor ===
</span><span class="code-line">=== Checking status of all nodes ===
</span><span class="code-line">Node on port 8081:
</span><span class="code-line">
</span><span class="code-line">Node on port 8082:
</span><span class="code-line">
</span><span class="code-line">Node on port 8083:
</span><span class="code-line">
</span><span class="code-line">=== Finding the Leader node ===
</span><span class="code-line">No leader found.
</span></code></pre></div><p>Soon after starting, you’ll see something like:</p><div class="relative"><pre><code class="code-highlight"><span class="code-line">Node on port 8081:
</span><span class="code-line">{
</span><span class="code-line">  &quot;id&quot;: 0,
</span><span class="code-line">  &quot;state&quot;: &quot;Leader&quot;,
</span><span class="code-line">  &quot;current_term&quot;: 15,
</span><span class="code-line">  ...
</span><span class="code-line">}
</span><span class="code-line">
</span><span class="code-line">Node on port 8082:
</span><span class="code-line">&quot;state&quot;: &quot;Follower&quot;
</span><span class="code-line">
</span><span class="code-line">Node on port 8083:
</span><span class="code-line">&quot;state&quot;: &quot;Follower&quot;
</span><span class="code-line">
</span><span class="code-line">=== Leader found on port 8081 ===
</span></code></pre></div><p>Yay, it elected a leader!</p><h2 id="kill-the-leader-for-science"><a href="#kill-the-leader-for-science" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Kill the Leader (for Science)</h2><p>When I <strong>Ctrl+C</strong> the leader process (port 8081), the cluster recovers:</p><div class="relative"><pre><code class="code-highlight"><span class="code-line">Node on port 8082:
</span><span class="code-line">&quot;state&quot;: &quot;Follower&quot;,
</span><span class="code-line">&quot;voted_for&quot;: 2,
</span><span class="code-line">&quot;current_term&quot;: 16
</span><span class="code-line">
</span><span class="code-line">Node on port 8083:
</span><span class="code-line">&quot;state&quot;: &quot;Leader&quot;,
</span><span class="code-line">&quot;voted_for&quot;: 2,
</span><span class="code-line">&quot;current_term&quot;: 16
</span><span class="code-line">
</span><span class="code-line">=== Leader found on port 8083 ===
</span></code></pre></div><p>Later, if I restart the killed node (<code>go run main.go 0</code>), it happily rejoins the cluster.</p><img width="580" src="/static/images/general/toyraft.png"/><h2 id="code-highlights-without-making-your-eyes-bleed"><a href="#code-highlights-without-making-your-eyes-bleed" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Code Highlights (Without Making Your Eyes Bleed)</h2><h3 id="the-basic-architecture"><a href="#the-basic-architecture" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The Basic Architecture</h3><p>Our implementation models each server as a <code>RaftNode</code> that can be in one of three states:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token comment">// NodeState represents the state of a node in the Raft cluster.</span>
</span><span class="code-line"><span class="token keyword">type</span> NodeState <span class="token builtin">int</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">const</span> <span class="token punctuation">(</span>
</span><span class="code-line">	Follower  NodeState <span class="token operator">=</span> <span class="token boolean">iota</span> 
</span><span class="code-line">	Candidate                  
</span><span class="code-line">	Leader                     
</span><span class="code-line"><span class="token punctuation">)</span>
</span></code></pre></div><ul><li><strong>Follower</strong>: The default state. Followers respond to requests from leaders and candidates</li><li><strong>Candidate</strong>: A node trying to become leader during an election</li><li><strong>Leader</strong>: The node that handles all client requests and coordinates log replication</li></ul><h3 id="core-data-structures"><a href="#core-data-structures" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Core Data Structures</h3><p>Each Raft node maintains several key pieces of state:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token comment">// RaftNode represents a single node in the Raft cluster.</span>
</span><span class="code-line"><span class="token keyword">type</span> RaftNode <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</span><span class="code-line">	id          <span class="token builtin">int</span>          <span class="token comment">// The unique ID for this node.</span>
</span><span class="code-line">	peers       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>     <span class="token comment">// The network addresses of the other nodes in the cluster.</span>
</span><span class="code-line">	state       NodeState    <span class="token comment">// The current state of the node (Follower, Candidate, or Leader).</span>
</span><span class="code-line">	currentTerm <span class="token builtin">int</span>          <span class="token comment">// The latest term the server has seen.</span>
</span><span class="code-line">	votedFor    <span class="token builtin">int</span>          <span class="token comment">// The candidateId that received a vote in the current term (-1 if none).</span>
</span><span class="code-line">	log         <span class="token punctuation">[</span><span class="token punctuation">]</span>LogEntry   <span class="token comment">// The log entries; the first entry is a sentinel.</span>
</span><span class="code-line">	commitIndex <span class="token builtin">int</span>          <span class="token comment">// The index of the highest log entry known to be committed.</span>
</span><span class="code-line"><span class="token comment">// ... other fields</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>The <code>currentTerm</code> is crucial - it&#x27;s like a logical clock that helps nodes understand the sequence of events in the cluster.</p><h3 id="leader-election"><a href="#leader-election" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Leader Election</h3><p>When a follower doesn&#x27;t hear from a leader for a certain time, it becomes a candidate and starts an election:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rn <span class="token operator">*</span>RaftNode<span class="token punctuation">)</span> <span class="token function">runElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">	rn<span class="token punctuation">.</span>currentTerm<span class="token operator">++</span>      <span class="token comment">// Increment term</span>
</span><span class="code-line">	rn<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> rn<span class="token punctuation">.</span>id    <span class="token comment">// Vote for ourselves</span>
</span><span class="code-line">	term <span class="token operator">:=</span> rn<span class="token punctuation">.</span>currentTerm
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// ... unlock and prepare request</span>
</span><span class="code-line">	votes <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rn<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">	votes <span class="token operator">&lt;-</span> <span class="token boolean">true</span> <span class="token comment">// Vote for self.</span>
</span><span class="code-line">
</span><span class="code-line">	<span class="token comment">// Send vote requests to all peers concurrently.</span>
</span><span class="code-line">	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> rn<span class="token punctuation">.</span>peers <span class="token punctuation">{</span>
</span><span class="code-line">		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>peerAddr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">            <span class="token comment">// ...</span>
</span><span class="code-line">			<span class="token keyword">if</span> resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> rn<span class="token punctuation">.</span><span class="token function">sendVoteRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> peerAddr<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line">				<span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line">				<span class="token keyword">case</span> votes <span class="token operator">&lt;-</span> resp<span class="token punctuation">.</span>VoteGranted<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">					<span class="token keyword">return</span> <span class="token comment">// Context timed out or was cancelled.</span>
</span><span class="code-line">				<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">				rn<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">				<span class="token comment">// If a response contains a higher term, step down and become a follower.</span>
</span><span class="code-line">				<span class="token keyword">if</span> resp<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rn<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
</span><span class="code-line">					rn<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> resp<span class="token punctuation">.</span>Term
</span><span class="code-line">					rn<span class="token punctuation">.</span>state <span class="token operator">=</span> Follower
</span><span class="code-line">					rn<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
</span><span class="code-line">					rn<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">				<span class="token punctuation">}</span>
</span><span class="code-line">				rn<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">			<span class="token punctuation">}</span>
</span><span class="code-line">		<span class="token punctuation">}</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">	<span class="token comment">// Tally the votes.</span>
</span><span class="code-line">	voteCount <span class="token operator">:=</span> <span class="token number">0</span>
</span><span class="code-line">	<span class="token keyword">for</span> vote <span class="token operator">:=</span> <span class="token keyword">range</span> votes <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token keyword">if</span> vote <span class="token punctuation">{</span>
</span><span class="code-line">			voteCount<span class="token operator">++</span>
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Check if we got majority votes</span>
</span><span class="code-line">	majority <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rn<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span>
</span><span class="code-line">	<span class="token keyword">if</span> voteCount <span class="token operator">&gt;=</span> majority <span class="token operator">&amp;&amp;</span> rn<span class="token punctuation">.</span>state <span class="token operator">==</span> Candidate <span class="token operator">&amp;&amp;</span> rn<span class="token punctuation">.</span>currentTerm <span class="token operator">==</span> term <span class="token punctuation">{</span>
</span><span class="code-line">		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Node %d became leader for term %d with %d votes&quot;</span><span class="token punctuation">,</span> rn<span class="token punctuation">.</span>id<span class="token punctuation">,</span> rn<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> voteCount<span class="token punctuation">)</span>
</span><span class="code-line">		rn<span class="token punctuation">.</span>state <span class="token operator">=</span> Leader
</span><span class="code-line">		rn<span class="token punctuation">.</span><span class="token function">initLeaderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">		<span class="token comment">// Stop the election timer as a leader.</span>
</span><span class="code-line">		<span class="token keyword">if</span> rn<span class="token punctuation">.</span>electionTimer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line">			rn<span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>The election process is straightforward:</p><ol><li>Increment the current term</li><li>Vote for yourself</li><li>Send vote requests to all other nodes</li><li>If you get a majority of votes, become leader</li></ol><h3 id="handling-vote-requests"><a href="#handling-vote-requests" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Handling Vote Requests</h3><p>When a node receives a vote request, it follows these rules:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rn <span class="token operator">*</span>RaftNode<span class="token punctuation">)</span> <span class="token function">handleVote</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// ... parse request</span>
</span><span class="code-line">
</span><span class="code-line">	resp <span class="token operator">:=</span> VoteResponse<span class="token punctuation">{</span>
</span><span class="code-line">		Term<span class="token punctuation">:</span>        rn<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span>
</span><span class="code-line">		VoteGranted<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Update term if candidate has higher term</span>
</span><span class="code-line">	<span class="token keyword">if</span> req<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rn<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
</span><span class="code-line">		rn<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> req<span class="token punctuation">.</span>Term
</span><span class="code-line">		rn<span class="token punctuation">.</span>state <span class="token operator">=</span> Follower
</span><span class="code-line">		rn<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Grant vote if conditions are met</span>
</span><span class="code-line">	<span class="token keyword">if</span> req<span class="token punctuation">.</span>Term <span class="token operator">==</span> rn<span class="token punctuation">.</span>currentTerm <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rn<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> rn<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> req<span class="token punctuation">.</span>CandidateID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">		lastLogIndex <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rn<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
</span><span class="code-line">		lastLogTerm <span class="token operator">:=</span> <span class="token number">0</span>
</span><span class="code-line">		<span class="token keyword">if</span> lastLogIndex <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
</span><span class="code-line">			lastLogTerm <span class="token operator">=</span> rn<span class="token punctuation">.</span>log<span class="token punctuation">[</span>lastLogIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>Term
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token comment">// ... send response</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>A node will vote for a candidate if:</p><ol><li>The candidate&#x27;s term is at least as high as the node&#x27;s current term</li><li>The node hasn&#x27;t already voted for someone else in this term</li><li>The candidate&#x27;s log is at least as up-to-date as the node&#x27;s log</li></ol><h3 id="heartbeats-and-log-replication"><a href="#heartbeats-and-log-replication" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Heartbeats and Log Replication</h3><p>Once elected, a leader must send regular heartbeats to maintain its authority:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rn <span class="token operator">*</span>RaftNode<span class="token punctuation">)</span> <span class="token function">sendHeartbeats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// ... prepare heartbeat request</span>
</span><span class="code-line">	<span class="token keyword">for</span> i<span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> rn<span class="token punctuation">.</span>peers <span class="token punctuation">{</span>
</span><span class="code-line">			req <span class="token operator">:=</span> AppendRequest<span class="token punctuation">{</span>
</span><span class="code-line">				Term<span class="token punctuation">:</span>         term<span class="token punctuation">,</span>
</span><span class="code-line">				LeaderID<span class="token punctuation">:</span>     rn<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
</span><span class="code-line">				PrevLogIndex<span class="token punctuation">:</span> prevLogIndex<span class="token punctuation">,</span>
</span><span class="code-line">				PrevLogTerm<span class="token punctuation">:</span>  prevLogTerm<span class="token punctuation">,</span>
</span><span class="code-line">				Entries<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span>LogEntry<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// Empty for heartbeats.</span>
</span><span class="code-line">				LeaderCommit<span class="token punctuation">:</span> leaderCommit<span class="token punctuation">,</span>
</span><span class="code-line">			<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">			<span class="token keyword">if</span> resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> rn<span class="token punctuation">.</span><span class="token function">sendAppendRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> peerAddr<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line">				<span class="token comment">// Handle response</span>
</span><span class="code-line">				<span class="token keyword">if</span> resp<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rn<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
</span><span class="code-line">                    <span class="token comment">// Step down if we discover higher term</span>
</span><span class="code-line">					rn<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> resp<span class="token punctuation">.</span>Term
</span><span class="code-line">					rn<span class="token punctuation">.</span>state <span class="token operator">=</span> Follower
</span><span class="code-line">					rn<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
</span><span class="code-line">					rn<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">				<span class="token punctuation">}</span>
</span><span class="code-line">			<span class="token punctuation">}</span>
</span><span class="code-line">		<span class="token punctuation">}</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>Heartbeats serve two purposes:</p><ol><li>They prevent followers from starting elections</li><li>They&#x27;re the same mechanism used for replicating log entries</li></ol><h3 id="the-main-loop"><a href="#the-main-loop" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The Main Loop</h3><p>Each node runs a simple state machine:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rn <span class="token operator">*</span>RaftNode<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line">			<span class="token comment">// Perform actions based on the current state.</span>
</span><span class="code-line">			<span class="token keyword">switch</span> state <span class="token punctuation">{</span>
</span><span class="code-line">			<span class="token keyword">case</span> Candidate<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token keyword">go</span> rn<span class="token punctuation">.</span><span class="token function">runElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">			<span class="token keyword">case</span> Leader<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token keyword">go</span> rn<span class="token punctuation">.</span><span class="token function">sendHeartbeats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">			<span class="token punctuation">}</span>
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>This loop ensures that:</p><ul><li>Followers wait for messages from leaders(NO <code>case</code> branch in <code>switch state</code>)</li><li>Candidates run elections when their timer expires</li><li>Leaders send regular heartbeats</li></ul><h3 id="election-timeouts"><a href="#election-timeouts" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Election Timeouts</h3><p>A critical part of Raft is the election timeout - how long a follower waits before becoming a candidate:</p><div class="relative"><pre><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rn <span class="token operator">*</span>RaftNode<span class="token punctuation">)</span> <span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token keyword">if</span> rn<span class="token punctuation">.</span>electionTimer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line">		rn<span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">	<span class="token comment">// Use a randomized timeout between 800ms and 1200ms.</span>
</span><span class="code-line">	timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token operator">+</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond
</span><span class="code-line">	rn<span class="token punctuation">.</span>electionTimer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">		rn<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">		<span class="token comment">// Only start an election if not already a leader.</span>
</span><span class="code-line">		<span class="token keyword">if</span> rn<span class="token punctuation">.</span>state <span class="token operator">!=</span> Leader <span class="token punctuation">{</span>
</span><span class="code-line">			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Node %d election timer expired, becoming candidate.&quot;</span><span class="token punctuation">,</span> rn<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</span><span class="code-line">			rn<span class="token punctuation">.</span>state <span class="token operator">=</span> Candidate
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">		rn<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>The randomization is important - it prevents multiple nodes from becoming candidates at the same time, which would split the vote.</p><h2 id="whats-missing"><a href="#whats-missing" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What&#x27;s Missing</h2><p>This implementation is simplified and missing several important features:</p><ol><li><strong>Log Compaction</strong>: In a real system, logs can&#x27;t grow forever</li><li><strong>Persistent State</strong>: Nodes should survive restarts</li><li><strong>Client Interface</strong>: There&#x27;s no way for clients to submit operations</li><li><strong>Membership Changes</strong>: Can&#x27;t add or remove nodes from the cluster</li></ol><h2 id="what-i-learned"><a href="#what-i-learned" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What I Learned</h2><p>This hands-on Raft experiment gave me a much better mental model of how HA works under the hood for products like open-source version of something.</p><p>More importantly, I understood why <strong>Raft hates long-distance relationships</strong>. Raft was designed for <strong>low-latency</strong> networks — like machines within the same <strong>data center or cloud region</strong>.</p><p>If you try to stretch a Raft cluster across regions (e.g., Region A, B, and C), the <strong>latency will kill it</strong>. Seriously.</p><p>You’ll run into:</p><ul><li>❌ Frequent leader elections (due to timeouts)</li><li>❌ Awful write performance (consensus needs roundtrips)</li><li>❌ Split-brain risks (everyone thinks they’re the leader 😵)</li></ul><p>So unless you’re operating within a tightly-knit region (like us in Region A), don&#x27;t stretch Raft too far. It gets grumpy.</p><h2 id="what-if-you-cant-afford-enterprise"><a href="#what-if-you-cant-afford-enterprise" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What If You Can’t Afford Enterprise?</h2><p>That brings me to the real question:</p><blockquote><p>“What if the enterprise version (which supports multi-region HA) isn’t approved for procurement?”</p></blockquote><p>I don&#x27;t have a perfect answer just yet; I&#x27;m still evaluating the trade-offs and expect to build some custom code to help reduce the risks. Perhaps I&#x27;ll have the opportunity to share more on this in the future.</p></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/architect">Architect</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/service-account-1">InfoSec architect 101-Service account from prehistory</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Supa Safe</div><div> • </div><div>© 2025</div><div> • </div><a href="/">Cybersecurity, Cloud and Compiler</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var t=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var i=a=\u003et(a,\"__esModule\",{value:!0});var N=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=\u003e{i(a);for(var c in s)t(a,c,{get:s[c],enumerable:!0})},g=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of h(s))!u.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026t(a,n,{get:()=\u003es[n],enumerable:!(c=p(s,n))||c.enumerable});return a},f=a=\u003eg(i(t(a!=null?d(m(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((x,o)=\u003e{o.exports=_jsx_runtime});var T={};k(T,{default:()=\u003eb,frontmatter:()=\u003ew});var e=f(r()),w={title:\"Consensus Algorithms Through the Eyes of an Infosec Architect\",date:\"2025-07-04\",tags:[\"Architect\"],draft:!1,summary:\"a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot\",images:[]};function y(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({p:\"p\",strong:\"strong\",blockquote:\"blockquote\",a:\"a\",h2:\"h2\",span:\"span\",ul:\"ul\",li:\"li\",pre:\"pre\",code:\"code\",h3:\"h3\",ol:\"ol\"},a.components),{Image:l}=n;return l||v(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"We\\u2019ve recently been evaluating some vendors for secrets management solutions. Due to some unfortunate legal or market reasons, well-known products like Akeyless can\\u2019t be sold in our local market. That pushed us to look into alternative solutions.\"}),(0,e.jsxs)(n.p,{children:[\"Now, secrets management demands \",(0,e.jsx)(n.strong,{children:\"extremely high availability\"}),\" (HA). I mean, nobody wants to wake up at 3 a.m. because the system storing your passwords decided to take a nap. So I spent some time analyzing how different vendors implement HA.\"]}),(0,e.jsxs)(n.p,{children:[\"Some vendors use a \",(0,e.jsx)(n.strong,{children:\"primary-standby model\"}),\" based on traditional databases like PostgreSQL. Others go fancier and adopt \",(0,e.jsx)(n.strong,{children:\"consensus algorithms\"}),\" like Raft.\"]}),(0,e.jsx)(n.p,{children:\"Yesterday, a teammate asked:\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"\\u201CWhat exactly is a consensus algorithm?\\u201D\"})}),(0,e.jsx)(n.p,{children:\"That question hit me right in the brainstem.\"}),(0,e.jsxs)(n.p,{children:[\"I once worked for a company with a product that had over a billion DAUs. Under the hood, it used a Paxos-based system called \",(0,e.jsx)(n.a,{href:\"https://github.com/Tencent/paxosstore\",children:\"paxosstore\"}),\". The core logic? Less than 2,000 lines of C++. Nowadays, I have to admit \\u2014 I can barely read that C++ anymore. But I thought \\u2014 why not write a tiny version of Raft myself in Go? Just for fun and to sharpen my understanding of the secret manager tech we\\u2019re reviewing.\"]}),(0,e.jsx)(n.p,{children:(0,e.jsxs)(n.strong,{children:[\"Disclaimer: My little Raft only does leader election, failure recovery, and node restarts. It\\u2019s not ready for production or serious use. If you want a deep dive into a more solid Go implementation, check out \",(0,e.jsx)(n.a,{href:\"https://eli.thegreenplace.net/2020/implementing-raft-part-1-elections/\",children:\"this excellent series\"}),\".\"]})}),(0,e.jsxs)(n.h2,{id:\"tldr\",children:[(0,e.jsx)(n.a,{href:\"#tldr\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"TL;DR\"]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"I wrote a Raft mini-clone in Go\"}),(0,e.jsx)(n.li,{children:\"It fits in a single file\"}),(0,e.jsx)(n.li,{children:\"It does elections and heartbeats\"}),(0,e.jsx)(n.li,{children:\"It doesn\\u2019t do log replication (yet)\"}),(0,e.jsx)(n.li,{children:\"But hey \\u2014 it was fun!\"})]}),(0,e.jsxs)(n.h2,{id:\"what-does-this-raft-do\",children:[(0,e.jsx)(n.a,{href:\"#what-does-this-raft-do\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What Does This Raft Do?\"]}),(0,e.jsx)(n.p,{children:\"Just the basics:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Leader election\"}),(0,e.jsx)(n.li,{children:\"Heartbeats\"}),(0,e.jsx)(n.li,{children:\"Failover (when leader dies, a new one is elected)\"}),(0,e.jsx)(n.li,{children:\"REST API for testing\"})]}),(0,e.jsx)(n.p,{children:\"Each node is just an HTTP server. They ping each other, vote for leaders, and complain when they don\\u2019t get love from others (i.e. no heartbeats).\"}),(0,e.jsxs)(n.h2,{id:\"how-does-it-work\",children:[(0,e.jsx)(n.a,{href:\"#how-does-it-work\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"How Does It Work?\"]}),(0,e.jsx)(n.p,{children:\"You start each node in a separate terminal:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`# Terminal 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`go run main.go 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`# Terminal 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`go run main.go 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`# Terminal 3\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`go run main.go 2\n`})]})}),(0,e.jsx)(n.p,{children:\"Meanwhile, I had a little monitoring shell script running to watch the cluster:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`$ ./test.sh monitor\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=== Raft Cluster Status Monitor ===\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=== Checking status of all nodes ===\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8081:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8082:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8083:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=== Finding the Leader node ===\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`No leader found.\n`})]})}),(0,e.jsx)(n.p,{children:\"Soon after starting, you\\u2019ll see something like:\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8081:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`{\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  \"id\": 0,\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  \"state\": \"Leader\",\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  \"current_term\": 15,\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  ...\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`}\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8082:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"state\": \"Follower\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8083:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"state\": \"Follower\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=== Leader found on port 8081 ===\n`})]})}),(0,e.jsx)(n.p,{children:\"Yay, it elected a leader!\"}),(0,e.jsxs)(n.h2,{id:\"kill-the-leader-for-science\",children:[(0,e.jsx)(n.a,{href:\"#kill-the-leader-for-science\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Kill the Leader (for Science)\"]}),(0,e.jsxs)(n.p,{children:[\"When I \",(0,e.jsx)(n.strong,{children:\"Ctrl+C\"}),\" the leader process (port 8081), the cluster recovers:\"]}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8082:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"state\": \"Follower\",\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"voted_for\": 2,\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"current_term\": 16\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Node on port 8083:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"state\": \"Leader\",\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"voted_for\": 2,\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\"current_term\": 16\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=== Leader found on port 8083 ===\n`})]})}),(0,e.jsxs)(n.p,{children:[\"Later, if I restart the killed node (\",(0,e.jsx)(n.code,{children:\"go run main.go 0\"}),\"), it happily rejoins the cluster.\"]}),(0,e.jsx)(l,{width:580,src:\"/static/images/general/toyraft.png\"}),(0,e.jsxs)(n.h2,{id:\"code-highlights-without-making-your-eyes-bleed\",children:[(0,e.jsx)(n.a,{href:\"#code-highlights-without-making-your-eyes-bleed\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Code Highlights (Without Making Your Eyes Bleed)\"]}),(0,e.jsxs)(n.h3,{id:\"the-basic-architecture\",children:[(0,e.jsx)(n.a,{href:\"#the-basic-architecture\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Basic Architecture\"]}),(0,e.jsxs)(n.p,{children:[\"Our implementation models each server as a \",(0,e.jsx)(n.code,{children:\"RaftNode\"}),\" that can be in one of three states:\"]}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"// NodeState represents the state of a node in the Raft cluster.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"type\"}),\" NodeState \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tFollower  NodeState \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"iota\"}),` \n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\tCandidate                  \n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\tLeader                     \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Follower\"}),\": The default state. Followers respond to requests from leaders and candidates\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Candidate\"}),\": A node trying to become leader during an election\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Leader\"}),\": The node that handles all client requests and coordinates log replication\"]})]}),(0,e.jsxs)(n.h3,{id:\"core-data-structures\",children:[(0,e.jsx)(n.a,{href:\"#core-data-structures\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Core Data Structures\"]}),(0,e.jsx)(n.p,{children:\"Each Raft node maintains several key pieces of state:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"// RaftNode represents a single node in the Raft cluster.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"type\"}),\" RaftNode \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tid          \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The unique ID for this node.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tpeers       \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"string\"}),\"     \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The network addresses of the other nodes in the cluster.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tstate       NodeState    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The current state of the node (Follower, Candidate, or Leader).\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tcurrentTerm \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The latest term the server has seen.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tvotedFor    \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The candidateId that received a vote in the current term (-1 if none).\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tlog         \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\"LogEntry   \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The log entries; the first entry is a sentinel.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tcommitIndex \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// The index of the highest log entry known to be committed.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ... other fields\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"The \",(0,e.jsx)(n.code,{children:\"currentTerm\"}),\" is crucial - it's like a logical clock that helps nodes understand the sequence of events in the cluster.\"]}),(0,e.jsxs)(n.h3,{id:\"leader-election\",children:[(0,e.jsx)(n.a,{href:\"#leader-election\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Leader Election\"]}),(0,e.jsx)(n.p,{children:\"When a follower doesn't hear from a leader for a certain time, it becomes a candidate and starts an election:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"runElection\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Increment term\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"id    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Vote for ourselves\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tterm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`currentTerm\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ... unlock and prepare request\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tvotes \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"make\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"chan\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"bool\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"len\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"peers\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tvotes \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c-\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"true\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Vote for self.\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Send vote requests to all peers concurrently.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"var\"}),\" wg sync\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`WaitGroup\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"_\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" peer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"range\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"peers \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\twg\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Add\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"go\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peerAddr \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"string\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" err \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"sendVoteRequest\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"ctx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" peerAddr\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" err \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"nil\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"select\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" votes \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c-\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"VoteGranted\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c-\"}),\"ctx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Done\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Context timed out or was cancelled.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"mu\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Lock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// If a response contains a higher term, step down and become a follower.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Term \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Term\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` Follower\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"resetElectionTimer\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"mu\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Unlock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Tally the votes.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tvoteCount \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" vote \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"range\"}),\" votes \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" vote \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tvoteCount\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Check if we got majority votes\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tmajority \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"len\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"peers\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" voteCount \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e=\"}),\" majority \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" Candidate \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" term \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tlog\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Printf\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Node %d became leader for term %d with %d votes\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"id\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" voteCount\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` Leader\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"initLeaderState\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Stop the election timer as a leader.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"electionTimer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"nil\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"electionTimer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Stop\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"The election process is straightforward:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsx)(n.li,{children:\"Increment the current term\"}),(0,e.jsx)(n.li,{children:\"Vote for yourself\"}),(0,e.jsx)(n.li,{children:\"Send vote requests to all other nodes\"}),(0,e.jsx)(n.li,{children:\"If you get a majority of votes, become leader\"})]}),(0,e.jsxs)(n.h3,{id:\"handling-vote-requests\",children:[(0,e.jsx)(n.a,{href:\"#handling-vote-requests\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Handling Vote Requests\"]}),(0,e.jsx)(n.p,{children:\"When a node receives a vote request, it follows these rules:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"handleVote\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"w http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"ResponseWriter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" r \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Request\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ... parse request\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tresp \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" VoteResponse\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"        rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tVoteGranted\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"false\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Update term if candidate has higher term\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Term \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Term\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` Follower\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Grant vote if conditions are met\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Term \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"||\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"CandidateID\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tlastLogIndex \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"len\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tlastLogTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" lastLogIndex \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlastLogTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"lastLogIndex\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Term\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ... send response\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"A node will vote for a candidate if:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsx)(n.li,{children:\"The candidate's term is at least as high as the node's current term\"}),(0,e.jsx)(n.li,{children:\"The node hasn't already voted for someone else in this term\"}),(0,e.jsx)(n.li,{children:\"The candidate's log is at least as up-to-date as the node's log\"})]}),(0,e.jsxs)(n.h3,{id:\"heartbeats-and-log-replication\",children:[(0,e.jsx)(n.a,{href:\"#heartbeats-and-log-replication\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Heartbeats and Log Replication\"]}),(0,e.jsx)(n.p,{children:\"Once elected, a leader must send regular heartbeats to maintain its authority:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"sendHeartbeats\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ... prepare heartbeat request\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" peer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"range\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"peers \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\treq \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" AppendRequest\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"         term\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tLeaderID\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"     rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"id\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tPrevLogIndex\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" prevLogIndex\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tPrevLogTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"  prevLogTerm\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tEntries\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\"LogEntry\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Empty for heartbeats.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\tLeaderCommit\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" leaderCommit\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" err \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"sendAppendRequest\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"ctx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" peerAddr\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" req\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" err \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"nil\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Handle response\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Term \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Step down if we discover higher term\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"currentTerm \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" resp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Term\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` Follower\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"votedFor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"resetElectionTimer\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"peer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Heartbeats serve two purposes:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsx)(n.li,{children:\"They prevent followers from starting elections\"}),(0,e.jsx)(n.li,{children:\"They're the same mechanism used for replicating log entries\"})]}),(0,e.jsxs)(n.h3,{id:\"the-main-loop\",children:[(0,e.jsx)(n.a,{href:\"#the-main-loop\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Main Loop\"]}),(0,e.jsx)(n.p,{children:\"Each node runs a simple state machine:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Perform actions based on the current state.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"switch\"}),\" state \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" Candidate\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"go\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"runElection\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"case\"}),\" Leader\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"go\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"sendHeartbeats\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"This loop ensures that:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[\"Followers wait for messages from leaders(NO \",(0,e.jsx)(n.code,{children:\"case\"}),\" branch in \",(0,e.jsx)(n.code,{children:\"switch state\"}),\")\"]}),(0,e.jsx)(n.li,{children:\"Candidates run elections when their timer expires\"}),(0,e.jsx)(n.li,{children:\"Leaders send regular heartbeats\"})]}),(0,e.jsxs)(n.h3,{id:\"election-timeouts\",children:[(0,e.jsx)(n.a,{href:\"#election-timeouts\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Election Timeouts\"]}),(0,e.jsx)(n.p,{children:\"A critical part of Raft is the election timeout - how long a follower waits before becoming a candidate:\"}),(0,e.jsx)(n.pre,{className:\"language-go\",children:(0,e.jsxs)(n.code,{className:\"language-go code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rn \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"RaftNode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"resetElectionTimer\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"electionTimer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"nil\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"electionTimer\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Stop\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Use a randomized timeout between 800ms and 1200ms.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\ttimeout \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":=\"}),\" time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Duration\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"800\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"rand\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Intn\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"400\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),`Millisecond\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"electionTimer \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"AfterFunc\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"timeout\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"func\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"mu\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Lock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// Only start an election if not already a leader.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" Leader \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlog\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Printf\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Node %d election timer expired, becoming candidate.\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" rn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"id\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"state \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` Candidate\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\trn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"mu\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Unlock\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"The randomization is important - it prevents multiple nodes from becoming candidates at the same time, which would split the vote.\"}),(0,e.jsxs)(n.h2,{id:\"whats-missing\",children:[(0,e.jsx)(n.a,{href:\"#whats-missing\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What's Missing\"]}),(0,e.jsx)(n.p,{children:\"This implementation is simplified and missing several important features:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Log Compaction\"}),\": In a real system, logs can't grow forever\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Persistent State\"}),\": Nodes should survive restarts\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Client Interface\"}),\": There's no way for clients to submit operations\"]}),(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Membership Changes\"}),\": Can't add or remove nodes from the cluster\"]})]}),(0,e.jsxs)(n.h2,{id:\"what-i-learned\",children:[(0,e.jsx)(n.a,{href:\"#what-i-learned\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What I Learned\"]}),(0,e.jsx)(n.p,{children:\"This hands-on Raft experiment gave me a much better mental model of how HA works under the hood for products like open-source version of something.\"}),(0,e.jsxs)(n.p,{children:[\"More importantly, I understood why \",(0,e.jsx)(n.strong,{children:\"Raft hates long-distance relationships\"}),\". Raft was designed for \",(0,e.jsx)(n.strong,{children:\"low-latency\"}),\" networks \\u2014 like machines within the same \",(0,e.jsx)(n.strong,{children:\"data center or cloud region\"}),\".\"]}),(0,e.jsxs)(n.p,{children:[\"If you try to stretch a Raft cluster across regions (e.g., Region A, B, and C), the \",(0,e.jsx)(n.strong,{children:\"latency will kill it\"}),\". Seriously.\"]}),(0,e.jsx)(n.p,{children:\"You\\u2019ll run into:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"\\u274C Frequent leader elections (due to timeouts)\"}),(0,e.jsx)(n.li,{children:\"\\u274C Awful write performance (consensus needs roundtrips)\"}),(0,e.jsx)(n.li,{children:\"\\u274C Split-brain risks (everyone thinks they\\u2019re the leader \\u{1F635})\"})]}),(0,e.jsx)(n.p,{children:\"So unless you\\u2019re operating within a tightly-knit region (like us in Region A), don't stretch Raft too far. It gets grumpy.\"}),(0,e.jsxs)(n.h2,{id:\"what-if-you-cant-afford-enterprise\",children:[(0,e.jsx)(n.a,{href:\"#what-if-you-cant-afford-enterprise\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What If You Can\\u2019t Afford Enterprise?\"]}),(0,e.jsx)(n.p,{children:\"That brings me to the real question:\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"\\u201CWhat if the enterprise version (which supports multi-region HA) isn\\u2019t approved for procurement?\\u201D\"})}),(0,e.jsx)(n.p,{children:\"I don't have a perfect answer just yet; I'm still evaluating the trade-offs and expect to build some custom code to help reduce the risks. Perhaps I'll have the opportunity to share more on this in the future.\"})]})}}var b=y;function v(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return T;})();\n;return Component;","toc":[{"value":"TL;DR","url":"#tldr","depth":2},{"value":"What Does This Raft Do?","url":"#what-does-this-raft-do","depth":2},{"value":"How Does It Work?","url":"#how-does-it-work","depth":2},{"value":"Kill the Leader (for Science)","url":"#kill-the-leader-for-science","depth":2},{"value":"Code Highlights (Without Making Your Eyes Bleed)","url":"#code-highlights-without-making-your-eyes-bleed","depth":2},{"value":"The Basic Architecture","url":"#the-basic-architecture","depth":3},{"value":"Core Data Structures","url":"#core-data-structures","depth":3},{"value":"Leader Election","url":"#leader-election","depth":3},{"value":"Handling Vote Requests","url":"#handling-vote-requests","depth":3},{"value":"Heartbeats and Log Replication","url":"#heartbeats-and-log-replication","depth":3},{"value":"The Main Loop","url":"#the-main-loop","depth":3},{"value":"Election Timeouts","url":"#election-timeouts","depth":3},{"value":"What's Missing","url":"#whats-missing","depth":2},{"value":"What I Learned","url":"#what-i-learned","depth":2},{"value":"What If You Can’t Afford Enterprise?","url":"#what-if-you-cant-afford-enterprise","depth":2}],"frontMatter":{"readingTime":{"text":"12 min read","minutes":11.29,"time":677400,"words":2258},"slug":"raft-algo","fileName":"raft-algo.md","title":"Consensus Algorithms Through the Eyes of an Infosec Architect","date":"2025-07-04T00:00:00.000Z","tags":["Architect"],"draft":false,"summary":"a.k.a. I wrote a Raft cluster in Go and accidentally learned a lot","images":[]}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.725,"time":43500,"words":145},"slug":["default"],"fileName":"default.md","name":"Supa Saf","avatar":"/static/images/avatar.jpg","occupation":"CISSP, CKS, AWS Certified Security – Specialty, Microsoft Cybersecurity Architect Expert","email":"nerd@supasaf.com","twitter":"https://twitter.com/supasaf","date":null}],"prev":{"title":"InfoSec architect 101-Service account from prehistory","date":"2025-07-01T00:00:00.000Z","tags":["Architect"],"draft":false,"summary":"Service accounts may sound boring, but they’re the unsung heroes of secure automation. In this post, we time-travel back to the prehistoric age of Windows domains to see how service accounts and Kerberos work together to avoid hardcoded passwords and security nightmares.","images":[],"slug":"service-account-1"},"next":null},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["raft-algo"]},"buildId":"iZpAoEZnD18JWfagLiBRw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>